# FreePBX 16 + Asterisk 18 Installation on Rocky Linux 9

## 0 Preface

This document is the log to denote the software migration process to Rocky Linux 9 based environment.

### 0.1 Server Environment

- **Linux Distribution**: Rocky Linux 9
- **CPU**: Intel(R) Xeon(R) CPU E5-2667 v4 @ 3.20GHz
  (x2)
- **Memory**: 3.6GB
- **Swap**: 15GB
- **Disk space**: 64GB

### 0.2 Software Version Dependency

Care must be taken the software dependency must meet; otherwise, FreePBX will not work properly.  
Although, Sangoma is not officially releasing the installation procedure for Rocky Linux 9 based platform, the team is working on FreePBX version 17 with Rocky Linux 8 environment, this document will evaluate and determine whether Rocky Linux 9 platform is relevant for production PBX use.

- **jansson**: version 2.14
- **php**: version remi-7.4
- **NodeJS**: version 10.24.1
- **Asterisk**: version 18.17.0
- **FreePBX**: version 16.0.40

## 1 Installation

### 1.1 Server Prep

#### 1.1.1 Update System Packages

Ensure to update the system packages before installation.

```
sudo dnf -y update
```

#### 1.1.2 Disable SELINUX

FreePBX require SELINUX to be disabled. Once disabled, reboot the server.

```
sudo sed -i 's/\(^SELINUX=\).*/\SELINUX=disabled/' /etc/sysconfig/selinux &&
sudo sed -i 's/\(^SELINUX=\).*/\SELINUX=disabled/' /etc/selinux/config &&
sudo reboot
```

Make sure the SELINUX is disabled.

```
# sestatus
SELinux status:                 disabled
```

#### 1.1.3 Firewalld Basic Configuration

[Note]: In my setup, chan_SIP was firstly deployed so that 5060 and 5061 are assigned for chan_SIP, and 5160 and 5161 are assigned for chan_PJSIP. In recent FreePBX release, these settings are opposite. (5060 & 5061 for chan_PJSIP, and 5160 & 5161 for chan_SIP)

- _80, 443/tcp_: FreePBX administration interface
- _5060/udp_: FreePBX chan_SIP signaling
- _5061/tcp_: FreePBX chan_SIP secure signaling
- _5160/udp_: FreePBX chan_PJSIP signaling
- _5161/tcp_: FreePBX chan_PJSIP secure signaling
- _8001, 8003/tcp_: UCP NodeJS Server
- _8088-8089/tcp_: Asterisk Builtin mini-HTTP server

```
firewall-cmd --zone=public --add-port=80/tcp --permanent &&
firewall-cmd --zone=public --add-port=443/tcp --permanent &&
firewall-cmd --zone=public --add-port=5060/udp --permanent &&
firewall-cmd --zone=public --add-port=5061/tcp --permanent &&
firewall-cmd --zone=public --add-port=5160/udp --permanent &&
firewall-cmd --zone=public --add-port=5161/tcp --permanent &&
firewall-cmd --zone=public --add-port=8001/tcp --permanent &&
firewall-cmd --zone=public --add-port=8003/tcp --permanent &&
firewall-cmd --zone=public --add-port=8088-8089/tcp --permanent &&&&
firewall-cmd --reload
```

#### 1.1.4 Install EPEL Repo

FreePBX requires **E**xtra **P**ackage for **E**nterprise **L**inux (EPEL).  
Run below to add the repository.

```
sudo yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm

```

Then, enable **C**ode **R**eady **B**uilder, crb (Powertools equivalent of Rocky Linux 8)

```
sudo dnf config-manager --set-enabled crb
```

#### 1.1.5 Install Development Related Packages

Install packages required for the build process.

```
sudo yum group -y install "Development Tools"
```

```
sudo dnf -y install git wget emacs-nox subversion net-tools kernel-devel sqlite-devel psmisc ncurses-devel newt-devel libxml2-devel libtiff-devel gtk2-devel libtool libuuid-devel crontabs cronie-anacron libedit libedit-devel gnutls-devel sox sox-devel unixODBC unixODBC-devel libtool-ltdl libtool-ltdl-devel
```

#### 1.1.6 Install MariaDB Database Server

Install Mariadb for FreePBX database.

```
sudo dnf -y install mariadb mariadb-server &&
sudo systemctl enable --now mariadb
```

Then, secure the MariaDB.

```
sudo mysql_secure_installation
  Switch to unix_socket authentication [Y/n] n
  Change the root password? [Y/n] n
  Remove anonymous users? [Y/n] Y
  Disallow root login remotely? [Y/n] Y
  Remove test database and access to it? [Y/n] Y
  Reload privilege tables now? [Y/n] Y
```

##### 1.1.6.1 Install ODBC and the MariaDB ODBC Connector

[Note]" Below packages are required to enable Call Detail Recording (CDR) feature to work properly.

```
sudo dnf -y install unixODBC unixODBC-devel libtool-ltdl libtool-ltdl-devel
```

##### 1.1.6.2 Install the latest MariaDB ODBC Connector

```
sudo dnf -y install mariadb-connector-odbc
```

##### 1.1.6.3 Configure ODBC and the MariaDB ODBC connector

FreePBX 16 will install `/etc/asterisk/res_odbc_additional.conf later and it looks like below.

```
;--------------------------------------------------------------------------------;
;          Do NOT edit this file as it is auto-generated by FreePBX.             ;
;--------------------------------------------------------------------------------;
; For information on adding additional paramaters to this file, please visit the ;
; FreePBX.org wiki page, or ask on IRC. This file was created by the new FreePBX ;
; BMO - Big Module Object. Any similarity in naming with BMO from Adventure Time ;
; is totally deliberate.                                                         ;
;--------------------------------------------------------------------------------;
[asteriskcdrdb]
enabled=>yes
dsn=>MySQL-asteriskcdrdb
pre-connect=>yes
max_connections=>5
username=>freepbxuser
password=>58bff6970944c331003d2e5449719201
database=>asteriskcdrdb
```

In above file, `dsn` field name is `MySQL-asteriskcdrdb` and this is the default name, but the default MariaDB installation will point MySQL driver which prevent CDR to work. (It will point to [MySQL] driver, `/usr/lib/libmyodbc8.so` won't exist; thus, CDR feature will not function properly. )

```
# Driver from the mysql-connector-odbc package in Fedora >=29
# Setup from the unixODBC package
[MySQL]
Description     = ODBC for MySQL 8
# mysql-connector-odbc package provides shared libraries with "w" or "a" suffix.
# 'w' stands for 'wide' or 'unicode' character set, 'a' stands for 'ANSI'
# Symlinks used in the configuration below lead to the 'w' variant by default
Driver          = /usr/lib/libmyodbc8.so
Driver64        = /usr/lib64/libmyodbc8.so
FileUsage       = 1
```

In order to avoid the CDR issue, explicitly define following two files.

- `/etc/odbcinst.ini`
  ```
  [MariaDB]
  Description=ODBC for MariaDB
  Driver=/usr/lib64/libmaodbc.so
  FileUsage=1
  UsageCount=3
  ```
- `/etc/odbc.ini`
  ```
  [MySQL-asteriskcdrdb]
  Description=MariaDB connection to 'asteriskcdrdb' database
  Driver=MariaDB
  server=localhost
  database=asteriskcdrdb
  Port=3306
  Socket=/var/lib/mysql/mysql.sock
  Option=3
  Charset=utf8
  UsageCount=1
  ```

#### 1.1.7 Make a Build Folder

Both Asterisk and FreePBX will be build from the source, create the folder for building and archiving the source.  
`/opt/app/usr/src` directory is created and build process will be done under this directory.

```
sudo mkdir -p /opt/app/usr/src &&
cd /opt/app/usr/src
```

### 1.2 Asterisk 18 Installation

#### 1.2.1 Install Asterisk 18

##### 1.2.1.1 Download the Archive

Since FreePBX 16 does not support Asterisk 20 as of 4/2/2023, download and install Asterisk 18.

```
cd /opt/app/usr/src &&
wget http://downloads.asterisk.org/pub/telephony/asterisk/asterisk-18-current.tar.gz &&
tar zxvf asterisk-18-current.tar.gz &&
cd asterisk-18.*/
```

##### 1.2.1.2 Install Prerequisit for Building Asterisk

Install necessary packages for Asterisk build process.

```
sudo ./contrib/scripts/install_prereq install &&
sudo ./contrib/scripts/get_mp3_source.sh
```

##### 1.2.1.3 Configure Asterisk

Once downloaded and unarchived, configure Asterisk.  
Since both jannson (C library required for media encoding/decoding) and PJSIP are bundled in the Asterisk's installation script, add `--with-jansson-bundled` and `--with-pjproject-bundled` switches respectively.

```
./configure --prefix=/usr --libdir=/usr/lib64 --with-jansson-bundled --with-pjproject-bundled --with-ssl=ssl
```

##### 1.2.1.4 Set Asterisk Menu Options

```
make menuselect
```

[Note]:

- When the menu pops up, install system message audio data (Core Sound Files) other than wav formats, (otherwise no message would heard from phoneset.)
  After selecting 'Save & Exit' continue for installation.
- Since Asterisk 18 deplicated app_macro.so, but FreePBX still uses it, it has to be selected in menuselect.

```
Add-ons (See README-addons.txt)
 +--> Select format_mp3
Applications
 +--> Select app_macro
Bridging Modules
Channel Event Logging
Channel Drivers
Codec Translators
 +---> Select all External Codecs
Format Interpreters
Dialplan Functions
PBX Modules
Resource Modules
Test Modules
Compiler Flags
Utilities
AGI Samples
Core Sound Packages
 +--> Select WAV, ULAW, ALAW, GSM, G729, G722
Music On Hold File Packages
 +--> Select WAV, ULAW, ALAW, GSM, G729, G722
MENUSELECT_EXTRA_SOUNDS
 +--> Select WAV, ULAW, ALAW, GSM, G729, G722
```

##### 1.2.1.5 Build Asterisk and Install

Now it is ready to build Asterisk.

```
make &&
make install
```

Once the installation is finished, the dummy configuration has to be generated for seemless FreePBX installation. To perform `make config`, `chkconfig` package needs to be installed for RL9, (RL8 has it installed by default).

```
mv /etc/init.d /tmp &&
dnf -y install chkconfig &&
cp /tmp/init.d/* /etc/init.d
```

[Note]: `/etc/init.d` directory has to be moved temporary to avoid installation error.

```
make basic-pbx &&
make config &&
ldconfig
```

##### 1.2.1.6 Add the Asterisk User and Group

Define asterisk user and group.

```
sudo groupadd asterisk &&
sudo useradd -r -d /opt/app/home/asterisk -g asterisk asterisk &&
sudo usermod -aG audio,dialout asterisk &&
sudo chown -R asterisk.asterisk /etc/asterisk /var/{lib,log,spool}/asterisk /usr/lib64/asterisk &&
mkhomedir_helper asterisk
```

[Note]:
`mkhomedir_helper` command will ensure the asterisk home directory is under `/opt/app/home/asterisk`.

Add below to make sure the process is run by `asterisk` user.

```
echo AST_USER="asterisk" >> /etc/sysconfig/asterisk &&
echo AST_GROUP="asterisk" >> /etc/sysconfig/asterisk &&
echo "runuser = asterisk" >> /etc/asterisk/asterisk.conf &&
echo "rungroup = asterisk" >> /etc/asterisk/asterisk.conf
```

### 1.3 FreePBX 16 Installation


#### 1.3.1 Install NodeJS (version 10.24.1)

Rocky Linux 9 comes with NodeJS version 18.

```
sudo dnf module list nodejs
```
But the ucp module will require a particular node module. (otherwise UCP Daemon error will appear on the dashboard)    
After the try and error, the version **10.24.1** will allow the module to be installed successfully, so specifically install the version.

Do not use dnf to install nodejs, rather use `n` package manager.Refere to https://github.com/tj/n, issue the following.

```
sudo su &&
export N_PREFIX=/usr/local/n &&
curl -L https://bit.ly/n-install | bash
```

Then, install the version **10.24.1**.
```
n install 10.24.1
```

Make sure the node version is 10.24.1.
```
# node -v
v10.24.1
# npm -v
6.14.12
```
#### 1.3.2 Install Apache Web Server

Install Apache for FreePBX GUI.

```
#Install httpd
sudo dnf -y install httpd

#remove default index.html page
sudo rm -f /var/www/html/index.html &&

#Start httpd and enable it to be starting automatically on system boot
sudo systemctl enable --now httpd &&

#If running an active firewall, ensure to open httpd
sudo firewall-cmd --add-service={http,https} --permanent &&
sudo firewall-cmd --reload
```

#### 1.3.3 Setting Secure Server

##### 1.3.3.1 Install mod_ssl

```
dnf -y install mod_ssl
```

##### 1.3.3.2 [Optional]: Modify /etc/httpd/conf.d/ssl.conf File

If the host already have the certificate, set them up.
Change below parameters. (change `domain.crt` and `domain.key` according to your env.)

- _SSLCertificateFile_ /etc/pki/tls/certs/domain.crt
- _SSLCertificateKeyFile_ /etc/pki/tls/private/domain.key

##### 1.3.3.3 Update CA certificate

```
update-ca-trust
```

##### 1.3.3.4 Create /etc/httpd/conf.d/https_redirect.conf

```
tee /etc/httpd/conf.d/https_redirect.conf << EOF
# Redirect all requests to port 80 to port 443 SSL via mod_rewrite
# Make sure the module is loaded and switched on
<IfModule !mod_rewrite.c>
  LoadModule rewrite_module /usr/lib/httpd/modules/mod_rewrite.so
</IfModule>

<IfModule mod_rewrite.c>
  RewriteEngine on

    # The line below sets the rewrite condition for mod_rewrite.so.
    # That is, if the server port does not equal 443, then this condition is true
    ReWriteCond %{SERVER_PORT} !^443$

  # redirect rule
  RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [NC,R,L]
</IfModule>
EOF
```

##### 1.3.3.5 Restart Apache Server

```
systemctl restart httpd.service
```

#### 1.3.4 Install PHP (PHP 7.4)

FreePBX is picky about PHP version. Installing version 7.4.

```
sudo dnf -y install yum-utils &&
sudo dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm &&
sudo dnf -y install https://rpms.remirepo.net/enterprise/remi-release-9.rpm
```

By default, php 8.1 is selected. Reset it and install `remi-7.4` version.

```
sudo dnf module -y reset php &&
sudo dnf module -y install php:remi-7.4
```

```
# dnf module list php
Last metadata expiration check: 0:26:07 ago on Mon 03 Apr 2023 06:03:19 AM CDT.
Rocky Linux 9 - AppStream
Name     Stream          Profiles                          Summary
php      8.1             common [d], devel, minimal        PHP scripting language

Remi's Modular repository for Enterprise Linux 9 - x86_64
Name     Stream          Profiles                          Summary
php      remi-7.4 [e]    common [d] [i], devel, minimal    PHP scripting language
php      remi-8.0        common [d], devel, minimal        PHP scripting language
php      remi-8.1        common [d], devel, minimal        PHP scripting language
php      remi-8.2        common [d], devel, minimal        PHP scripting language
```

Then, install required extensions.

```
sudo dnf install -y php php-pear php-cgi php-common php-curl php-mbstring php-gd php-mysqlnd php-gettext php-bcmath php-zip php-xml php-json php-process php-snmp php-ldap php-pdo php-opcache php-intl php-soap &&
sudo pear install Console_Getopt
```

Set the max upload size for php to 120M.

```
sudo sed -i 's/\(^upload_max_filesize = \).*/\120M/' /etc/php.ini
```

Then, enable and start `php-fpm` PHP-FPM (FastCGI Process Manager) service.

```
systemctl enable php-fpm &&
systemctl start php-fpm
```

```
sudo sed -i 's/\(^memory_limit = \).*/\1128M/' /etc/php.ini &&
sudo sed -i 's/^\(User\|Group\).*/\1 asterisk/' /etc/httpd/conf/httpd.conf &&
sudo sed -i 's/AllowOverride None/AllowOverride All/' /etc/httpd/conf/httpd.conf &&
sudo sed -i 's/\(^user = \).*/\1asterisk/' /etc/php-fpm.d/www.conf &&
sudo sed -i 's/\(^group = \).*/\1asterisk/' /etc/php-fpm.d/www.conf &&
sudo sed -i 's/\(^listen.acl_users = \).*/\1apache,nginx,asterisk/' /etc/php-fpm.d/www.conf
```

#### 1.3.5 FreePBX Installation

Download the latest FreePBX 16 and install.

```
cd /opt/app/usr/src &&
wget http://mirror.freepbx.org/modules/packages/freepbx/7.4/freepbx-16.0-latest.tgz &&
tar zxvf freepbx-16.0-latest.tgz &&
cd freepbx
```

Then run the installation script...

```
cd /opt/app/usr/src/asterisk-18.* &&
make basic-pbx &&
make config &&
ldconfig &&
cd /opt/app/usr/src/freepbx &&
./start_asterisk restart &&
ps aux | grep asterisk &&
rm -f /etc/asterisk/asterisk.conf &&
./install -n
```

Install all FreePBX modules.

```
fwconsole ma disablerepo commercial &&
fwconsole ma enablerepo extended &&
fwconsole ma installall &&
fwconsole ma delete firewall &&
fwconsole chown &&
fwconsole reload &&
fwconsole restart
```

Restart the Web services.

```
sudo systemctl restart httpd php-fpm
```

#### 1.3.6 Create FreePBX Systemd Startup script

Create a systemd unit for auto-starting the service.

```
sudo tee /etc/systemd/system/freepbx.service << EOF
[Unit]
Description=FreePBX VoIP Server
After=mariadb.service
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/sbin/fwconsole start -q
ExecStop=/usr/sbin/fwconsole stop -q
[Install]
WantedBy=multi-user.target
EOF
```

Then, enable and start the FreePBX service.

```
sudo systemctl daemon-reload &&
sudo systemctl enable freepbx &&
sudo systemctl start freepbx
```

#### 1.3.6 Check Asterisk CDR Feature

Check the CDR connection is set correctly.

```
# asterisk -rx "cdr show status"

Call Detail Record (CDR) settings
----------------------------------
  Logging:                    Enabled
  Mode:                       Simple
  Log calls by default:       Yes
  Log unanswered calls:       No
  Log congestion:             No

  Ignore bridging changes:    No

  Ignore dial state changes:  No

* Registered Backends
  -------------------
    Adaptive ODBC

# asterisk -rx "odbc show"

ODBC DSN Settings
-----------------

  Name:   asteriskcdrdb
  DSN:    MySQL-asteriskcdrdb
    Number of active connections: 1 (out of 5)
    Logging: Disabled
```

#### 1.3.7 [Side Note]: Reinstallation Procedure

[Note]: FreePBX installer is quite fragile and breaks if Asterisk is not running properly.    
In case if the installation script breaks, uninstall all from the host server and start over again.

```
# Stop the services
systemctl stop mariadb &&
systemctl stop mysql &&
systemctl stop asterisk &&
systemctl stop freepbx &&
systemctl stop httpd &&
systemctl stop php-fpm &&
# Remove Asterisk related folders
cd /opt/app/usr/src/asterisk-18.* &&
make uninstall-all &&
# Remove remaining files in /etc
rm -f /etc/amportal.conf &&
rm -f /etc/freepbx.conf &&
# Remove Asterisk/FreePBX folders
rm -fr /usr/lib64/asterisk &&
rm -fr /var/www/html/admin &&
rm -fr /var/lib/asterisk &&
rm -fr /var/spool/asterisk &&
rm -fr /opt/app/home/asterisk &&
rm -fr /var/log/asterisk &&
# Remove MariaDB related and reinstall
rm -fr /var/lib/mysql &&
dnf -y reinstall mariadb-server mariadb
# Restart mariadb, mysql, httpd and php-fpm
systemctl restart mariadb &&
systemctl restart mysql &&
systemctl restart httpd &&
systemctl restart php-fpm &&
# Change into Asterisk directory
cd /opt/app/usr/src/asterisk-18.* &&
# Install asterisk again
make install && make basic-pbx && make config && ldconfig &&
# Change the permission
chown -R asterisk.asterisk /etc/asterisk /var/{lib,log,spool}/asterisk /usr/lib64/asterisk &&
# Start asterisk from FreePBX script
cd /opt/app/usr/src/freepbx &&
./start_asterisk kill
```

Script end the process like below...
```
KILLING AMP PROCESSES
mpg123: no process found
kill: not enough arguments
op_server.pl: no process found
```

Make sure no asterisk is running.

```
cd /opt/app/usr/src/freepbx &&
ps aux | grep asterisk
```

Then run the rest of the script to reinstall FreePBX.

```
cd /opt/app/usr/src/freepbx &&
./start_asterisk start &&
# Remove below so that FreePBX installer go through without error.
rm -f /etc/asterisk/asterisk.conf &&
# Finally start the installation
./install -n
```

Finally, install all the modules.

```
fwconsole ma disablerepo commercial &&
fwconsole ma enablerepo extended &&
fwconsole ma installall &&
fwconsole ma delete firewall &&
fwconsole chown &&
fwconsole reload &&
fwconsole restart
```

#### 1.3.8 Accessing FreePBX from the Web Browser

Access the host server GUI then set `username`, `password` and `notification email` as requested on the page followed by clicking `set up system` at the bottom right. This will lead to the language selection page, select the language (English) then `submit`. If all goes well, FreePBX login page will show up.
